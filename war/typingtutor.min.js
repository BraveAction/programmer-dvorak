//Typing Tutor jQuery plugin
// 
(function(c){c.fn.typingtutor=function(p){function B(a,b){e[a]&&e[a][b]&&e[a][b].css("background-color",L)}function t(a,b){e[a]&&e[a][b]&&e[a][b].css("background-color",C)}function k(a,b){e[a]&&e[a][b]&&e[a][b].css("background-color",M)}function D(){u=!0;v++;w&&w.call(this,v)}function x(a,b){e[a]&&e[a][b]&&e[a][b].css("background-color",N);q=null;l.length=0;D()}function E(){var a=f.value,b=a.split(/\n/g);"msie"===c.browser.name&&-1!==a.indexOf("\n",a.length-1)&&b.push("");return b}function y(){var a=
E();return a[a.length-1]}p=c.extend({speedInterval:4},p);var F=this[0],f=this[1];c(f).css("resize","none");c(f).attr("onpaste","return false;");for(var d=0,m=c(F).find("p"),g=[],e=[],r=0,h=0;h<m.length;h++){m[h]=c(m[h]);var n=c.trim(m[h].text()).replace(/\t/g," "),r=r+n.length;m[h][0].innerHTML="";g[h]=n;e[h]=[];for(var s=0;s<n.length;s++){var G=c("<span>"+n.charAt(s)+"</span>");m[h].append(G);e[h][s]=G}n=c("<span>&nbsp;</span>");e[h][s]=n;m[h].append(n);g[h]+=" "}r-=1;c(F).css("font-family",'"Courier New", Courier, monospace');
k(0,0);var L="rgb(201, 255, 224)",C="rgb(255, 255, 255)",M="rgb(198, 222, 162)",N="rgb(255, 97, 136)",O=p.speedInterval,q,l=[],z=p.speedTrackCallback,H=p.finishCallback,A=null,v=0,w=p.errorCallback,u=!1,I=function(a){A||(A=(new Date).getTime());if(8!==a.keyCode&&13!==a.keyCode){var b=y(),e=b.length;if(g[d])if(e>=g[d].length-1&&32===a.which)a.preventDefault(),a=new jQuery.Event("keydown"),a.which=a.keyCode=13,c(f).trigger(a),c(f).val(c(f).val()+"\n");else if(e>g[d].length-1)D();else if(g[d].substring(0,
e+1)===b+String.fromCharCode(a.which)){u=!1;B(d,e);k(d,e+1);if(z){b=(new Date).getTime();if(q&&(l.push(b-q),l.length===O)){var h=0;c.each(l,function(a,b){h+=b});z.call(this,parseInt(6E4/(h/l.length)));l.length=0}q=b}H&&(!u&&g.length-1===d&&g[g.length-1].length-2===e)&&(e=(new Date).getTime()-A,H.call(this,parseInt(6E4*(r/e))),c(f).val(c(f).val()+String.fromCharCode(a.which)),c(f).attr("disabled",!0),c(f).unbind("keypress"),c(f).unbind("keydown"),c(f).unbind("keyup"))}else x(d,e)}},J=function(a){if(8===
a.keyCode){var b=y();a=b.length;0<a?g[d]&&(a<g[d].length&&t(d,a),1<a?a-1<g[d].length&&(t(d,a-1),g[d].substring(0,a-1)===b.substring(0,a-1)?k(d,a-1):x(d,a-2)):k(d,0)):0!==d&&g[d]&&(t(d,0),d--,b=E()[d],a=b.length+1,c.trim(g[d]).substring(0,a-1)===c.trim(b).substring(0,a-1)?k(d,a-1):x(d,a-2))}else 13===a.keyCode&&(b=y(),c.trim(g[d])!==b?(x(d,b.length),a.preventDefault()):(B(d,b.length),d++,k(d,0)))},K=function(a){a=y();var b=a.length;if(!(b>=e[d].length)){for(var f=b+1;f<e[d].length;f++)t(d,f);c.trim(g[d]).substring(0,
b-1)===c.trim(a).substring(0,b-1)&&k(d,b)}};c(f).keypress(I);c(f).keydown(J);c(f).keyup(K);c(f).focus();k(0,0);return{restart:function(){c.each(e,function(a,b){c.each(b,function(a,b){b.css("background-color",C)})});k(0,0);d=0;c(f).val("").attr("disabled",!1).focus();v=0;w&&w.call(this,v);u=!1;z&&z.call(this,0);q=null;l.length=0;A=null;c(f).keypress(I);c(f).keydown(J);c(f).keyup(K)}}}})(jQuery);